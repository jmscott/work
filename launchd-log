#/bin/bash
#
#  Synopsis:
#	Trivial script to init and log start/stop of process execed by launchd.
#  Usage:
#	cd /usr/local/blobio
#	
#	#  source in optional config script
#	echo 'ulimit -n 2048' >>etc/launch-log.conf
#
#	launchd-log bin/flowd server etc/blobio.flow
#
#  Exit Status:
#	*	exit status of launched process
#  	127	unexpected error in launchd-log
#  Note:
#	Consider renamed to launchd-helper.
#

PROG=$(basename $0)

log()
{
	echo "$PROG: $(date +'%Y/%m/%d %H:%M:%S'): $@"
}

leave()
{
	log 'good bye, cruel world'
	exit
}

die()
{
	log "ERROR: $@" >&1
	exit 127
}

test $# -gt 0 || die 'wrong number of arguments, expected > 0'
PROG="$PROG: $(basename $1)"

log "hello, world"
trap leave EXIT TERM INT QUIT

CONF=etc/launchd-log.conf
if [ -r $CONF ];  then
	log "sourcing conf file: $CONF"
	. $CONF
fi

log "executing: $@"
$@ 2>&1 | while read LINE;  do
	log $LINE
done
STATUS=${PIPESTATUS[*]}
log "process exited with status: $STATUS" 
STATUS=$(echo $STATUS | awk '{print $1}')
exit $STATUS
